- name: Create kubeadm token on first node
  delegate_to: "{{ groups['k8s-servers'] | first }}"
  command: kubeadm token create --ttl 1h
  register: kubeadm_token

- name: Join workers to the cluster
  command: >-
    kubeadm join
    {{ k8s_api_loadbalancer_dns }}:{{ k8s_api_loadbalancer_port }}
    --token {{ kubeadm_token.stdout.strip() }}
    --discovery-token-unsafe-skip-ca-verification
    --node-name {{ ansible_fqdn }}
  register: join_cluster
  until: join_cluster is succeeded
  retries: 30
  delay: 10

- name: Label worker node
  command: >-
    kubectl
    --kubeconfig /etc/kubernetes/super-admin.conf
    label
    node
    {{ ansible_fqdn }}
    node-role.kubernetes.io/worker=''
  delegate_to: "{{ groups['k8s-servers'][0] }}"
